# Azure DevOps Pipeline for Portfolio Deployment
# File: azure-pipelines.yml
# ÂÆåÊï¥Êó†sudoÁâàÊú¨ - 2025Âπ¥9Êúà13Êó•Êõ¥Êñ∞

trigger:
  branches:
    include:
      - main
      - master
      - develop
  paths:
    exclude:
      - README.md
      - docs/*

pool:
  name: 'Default'

variables:
  # Build variables
  nodeVersion: '18.x'
  buildPath: '$(System.DefaultWorkingDirectory)'
  
  # Deployment variables
  targetServer: 'www.bon.cc'
  deployPath: '/var/www/portfolio'
  backupPath: '~/portfolio-backups'
  
stages:
- stage: Build
  displayName: 'Build Stage'
  jobs:
  - job: BuildJob
    displayName: 'Build Portfolio'
    steps:
    # Checkout source code
    - checkout: self
      clean: true
      fetchDepth: 1
    
    # Setup Node.js
    - task: NodeTool@0
      displayName: 'Setup Node.js'
      inputs:
        versionSpec: '$(nodeVersion)'
        checkLatest: true
    
    # Cache node_modules
    - task: Cache@2
      displayName: 'Cache node_modules'
      inputs:
        key: 'npm | "$(Agent.OS)" | package-lock.json'
        restoreKeys: |
          npm | "$(Agent.OS)"
        path: '$(System.DefaultWorkingDirectory)/node_modules'
    
    # Install dependencies
    - script: |
        npm ci --prefer-offline --no-audit
      displayName: 'Install Dependencies'
      workingDirectory: '$(buildPath)'
    
    # Run tests (if available)
    - script: |
        if [ -f "package.json" ] && grep -q '"test"' package.json; then
          npm run test -- --coverage --watchAll=false
        else
          echo "No test script found, skipping tests"
        fi
      displayName: 'Run Tests'
      workingDirectory: '$(buildPath)'
      continueOnError: true
    
    # Build the Next.js project
    - script: |
        echo "Building Next.js portfolio project..."
        NODE_OPTIONS=--openssl-legacy-provider npm run build
        echo "Build completed successfully"
      displayName: 'Build Project'
      workingDirectory: '$(buildPath)'
    
    # Verify build output
    - script: |
        echo "=== Verifying build output ==="
        echo "Current directory contents:"
        ls -la
        echo ""
        if [ -d "out" ]; then
          echo "‚úÖ out folder exists"
          echo "Files in out folder:"
          ls -la out/ | head -10
          echo "Total files: $(find out -type f | wc -l)"
        else
          echo "‚ùå out folder not found"
          echo "Available directories:"
          ls -la | grep "^d"
          exit 1
        fi
      displayName: 'Verify Build Output'
      workingDirectory: '$(buildPath)'
    
    # Archive build artifacts
    - task: ArchiveFiles@2
      displayName: 'Archive Build Files'
      condition: and(succeeded(), ne(variables['Agent.JobStatus'], 'Failed'))
      inputs:
        rootFolderOrFile: '$(Build.SourcesDirectory)/out' 
        includeRootFolder: false
        archiveType: 'tar'
        archiveFile: '$(Build.ArtifactStagingDirectory)/portfolio-$(Build.BuildId).tar.gz'
        replaceExistingArchive: true
    
    # Verify archive was created
    - script: |
        echo "=== Checking build artifacts ==="
        ls -la $(Build.ArtifactStagingDirectory)/
        if [ -f "$(Build.ArtifactStagingDirectory)/portfolio-$(Build.BuildId).tar.gz" ]; then
          echo "‚úÖ Archive created successfully"
          echo "Archive size: $(du -h $(Build.ArtifactStagingDirectory)/portfolio-$(Build.BuildId).tar.gz)"
          echo "Archive contents (first 10 files):"
          tar -tzf "$(Build.ArtifactStagingDirectory)/portfolio-$(Build.BuildId).tar.gz" | head -10
        else
          echo "‚ùå Archive not found"
          exit 1
        fi
      displayName: 'Verify Archive'
    
    # Publish artifacts
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Build Artifacts'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'portfolio-build'
        publishLocation: 'Container'

- stage: Deploy
  displayName: 'Deploy Stage'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - deployment: DeployToVM
    displayName: 'Deploy to Virtual Machine'
    environment: 'Production'
    strategy:
      runOnce:
        deploy:
          steps:
          # Download build artifacts
          - download: current
            artifact: portfolio-build
          
          # Create backup (ÂÆåÂÖ®Êó†sudoÁâàÊú¨)
          - task: SSH@0
            displayName: 'Create Backup'
            inputs:
              sshEndpoint: 'VM-SSH-Connection'
              runOptions: 'inline'
              inline: |
                #!/bin/bash
                set -e
                
                echo "=== BACKUP PROCESS STARTED ==="
                echo "User: $(whoami)"
                echo "Home: $HOME"
                echo "Current time: $(date)"
                echo ""
                
                # ÂÆö‰πâË∑ØÂæÑÂèòÈáè
                DEPLOY_DIR="/var/www/portfolio"
                BACKUP_BASE_DIR="$HOME/portfolio-backups"
                TIMESTAMP=$(date +%Y%m%d_%H%M%S)
                BACKUP_DIR="$BACKUP_BASE_DIR/backup-$TIMESTAMP"
                
                # ÂàõÂª∫Â§á‰ªΩÂü∫Á°ÄÁõÆÂΩï
                echo "Creating backup base directory: $BACKUP_BASE_DIR"
                mkdir -p "$BACKUP_BASE_DIR"
                
                # Ê£ÄÊü•ÊòØÂê¶ÊúâÁé∞ÊúâÈÉ®ÁΩ≤ÈúÄË¶ÅÂ§á‰ªΩ
                if [ -d "$DEPLOY_DIR" ] && [ "$(ls -A $DEPLOY_DIR 2>/dev/null)" ]; then
                  echo "Found existing deployment, creating backup..."
                  echo "Source: $DEPLOY_DIR"
                  echo "Target: $BACKUP_DIR"
                  
                  # ÂàõÂª∫Â§á‰ªΩ
                  mkdir -p "$BACKUP_DIR"
                  cp -r "$DEPLOY_DIR"/* "$BACKUP_DIR/" 2>/dev/null
                  
                  # È™åËØÅÂ§á‰ªΩ
                  if [ "$(ls -A $BACKUP_DIR 2>/dev/null)" ]; then
                    echo "‚úÖ Backup created successfully"
                    echo "Backup location: $BACKUP_DIR"
                    echo "Backup size: $(du -sh $BACKUP_DIR | cut -f1)"
                  else
                    echo "‚ö†Ô∏è  Backup directory is empty, but continuing..."
                  fi
                  
                  # Ê∏ÖÁêÜÊóßÂ§á‰ªΩÔºå‰øùÁïôÊúÄÊñ∞5‰∏™
                  echo ""
                  echo "Cleaning up old backups..."
                  OLD_BACKUPS=$(ls -1t "$BACKUP_BASE_DIR"/backup-* 2>/dev/null | tail -n +6)
                  if [ -n "$OLD_BACKUPS" ]; then
                    echo "$OLD_BACKUPS" | xargs rm -rf
                    echo "‚úÖ Old backups cleaned up"
                  else
                    echo "‚ÑπÔ∏è  No old backups to clean"
                  fi
                  
                else
                  echo "‚ÑπÔ∏è  No existing deployment found at $DEPLOY_DIR"
                  echo "This might be the first deployment"
                fi
                
                echo ""
                echo "Current backups:"
                ls -la "$BACKUP_BASE_DIR"/ 2>/dev/null || echo "No backups directory yet"
                
                echo ""
                echo "‚úÖ BACKUP PROCESS COMPLETED"
          
          # Copy files to server
          - task: CopyFilesOverSSH@0
            displayName: 'Copy Files to Server'
            inputs:
              sshEndpoint: 'VM-SSH-Connection'
              sourceFolder: '$(Pipeline.Workspace)/portfolio-build/'
              contents: 'portfolio-$(Build.BuildId).tar.gz'
              targetFolder: '/tmp/'
              cleanTargetFolder: false
          
          # Deploy application (ÂÆåÂÖ®Êó†sudoÁâàÊú¨)
          - task: SSH@0
            displayName: 'Deploy Application'
            inputs:
              sshEndpoint: 'VM-SSH-Connection'
              runOptions: 'inline'
              inline: |
                #!/bin/bash
                set -e
                
                echo "=== DEPLOYMENT PROCESS STARTED ==="
                echo "User: $(whoami)"
                echo "Build ID: $(Build.BuildId)"
                echo "Current time: $(date)"
                echo ""
                
                # ÂÆö‰πâË∑ØÂæÑÂèòÈáè
                DEPLOY_DIR="/var/www/portfolio"
                ARCHIVE_FILE="/tmp/portfolio-$(Build.BuildId).tar.gz"
                
                # È™åËØÅ‰∏ä‰º†ÁöÑÊñá‰ª∂Â≠òÂú®
                echo "Checking uploaded archive..."
                if [ ! -f "$ARCHIVE_FILE" ]; then
                  echo "‚ùå Archive file not found: $ARCHIVE_FILE"
                  echo "Available files in /tmp:"
                  ls -la /tmp/portfolio-* 2>/dev/null || echo "No portfolio files found"
                  exit 1
                fi
                
                echo "‚úÖ Archive file found: $ARCHIVE_FILE"
                echo "Archive size: $(du -sh $ARCHIVE_FILE | cut -f1)"
                echo ""
                
                # Ê£ÄÊü•ÈÉ®ÁΩ≤ÁõÆÂΩïÂíåÊùÉÈôê
                echo "Checking deployment directory permissions..."
                if [ ! -d "$DEPLOY_DIR" ]; then
                  echo "‚ùå Deployment directory does not exist: $DEPLOY_DIR"
                  echo ""
                  echo "TO FIX THIS, run on server:"
                  echo "sudo mkdir -p $DEPLOY_DIR"
                  echo "sudo chown -R $(whoami):www-data $DEPLOY_DIR"
                  echo "sudo chmod -R 755 $DEPLOY_DIR"
                  exit 1
                elif [ ! -w "$DEPLOY_DIR" ]; then
                  echo "‚ùå No write permission to deployment directory: $DEPLOY_DIR"
                  echo "Current owner: $(ls -ld $DEPLOY_DIR | awk '{print $3":"$4}')"
                  echo ""
                  echo "TO FIX THIS, run on server:"
                  echo "sudo chown -R $(whoami):www-data $DEPLOY_DIR"
                  echo "sudo chmod -R 755 $DEPLOY_DIR"
                  exit 1
                fi
                
                echo "‚úÖ Deployment directory permissions OK"
                echo "Directory: $DEPLOY_DIR"
                echo "Owner: $(ls -ld $DEPLOY_DIR | awk '{print $3":"$4}')"
                echo ""
                
                # Ê∏ÖÁ©∫ÈÉ®ÁΩ≤ÁõÆÂΩï
                echo "Clearing deployment directory..."
                rm -rf "$DEPLOY_DIR"/*
                echo "‚úÖ Deployment directory cleared"
                echo ""
                
                # Ëß£ÂéãÂíåÈÉ®ÁΩ≤
                echo "Extracting and deploying archive..."
                cd /tmp
                
                # Ê£ÄÊü•ÂéãÁº©ÂåÖÂÜÖÂÆπ
                echo "Archive contents preview:"
                tar -tzf "$ARCHIVE_FILE" | head -5
                echo "..."
                echo "Total files: $(tar -tzf $ARCHIVE_FILE | wc -l)"
                echo ""
                
                # Ëß£ÂéãÂà∞ÈÉ®ÁΩ≤ÁõÆÂΩï
                tar -xzf "$ARCHIVE_FILE" -C "$DEPLOY_DIR"
                echo "‚úÖ Archive extracted to deployment directory"
                echo ""
                
                # ËÆæÁΩÆÊñá‰ª∂ÊùÉÈôê
                echo "Setting file permissions..."
                chmod -R 755 "$DEPLOY_DIR"
                echo "‚úÖ File permissions set (755)"
                echo ""
                
                # È™åËØÅÈÉ®ÁΩ≤
                echo "Verifying deployment..."
                if [ "$(ls -A $DEPLOY_DIR 2>/dev/null)" ]; then
                  echo "‚úÖ Deployment verification passed"
                  echo "Deployed files count: $(find $DEPLOY_DIR -type f | wc -l)"
                  echo "Deployment size: $(du -sh $DEPLOY_DIR | cut -f1)"
                else
                  echo "‚ùå Deployment verification failed - directory is empty"
                  exit 1
                fi
                echo ""
                
                # Â∞ùËØïÈáçÂêØWebÊúçÂä°Âô®
                echo "Attempting web server restart..."
                WEB_SERVER_RESTARTED=false
                
                if command -v systemctl >/dev/null 2>&1; then
                  # Ê£ÄÊü•Nginx
                  if systemctl is-active --quiet nginx 2>/dev/null; then
                    echo "Found active Nginx service"
                    if systemctl reload nginx 2>/dev/null; then
                      echo "‚úÖ Nginx reloaded successfully"
                      WEB_SERVER_RESTARTED=true
                    else
                      echo "‚ö†Ô∏è  Could not reload Nginx without sudo"
                      echo "TO FIX: Add to /etc/sudoers.d/webserver-reload:"
                      echo "$(whoami) ALL=(ALL) NOPASSWD: /usr/bin/systemctl reload nginx"
                    fi
                  # Ê£ÄÊü•Apache
                  elif systemctl is-active --quiet apache2 2>/dev/null; then
                    echo "Found active Apache2 service"
                    if systemctl reload apache2 2>/dev/null; then
                      echo "‚úÖ Apache2 reloaded successfully"
                      WEB_SERVER_RESTARTED=true
                    else
                      echo "‚ö†Ô∏è  Could not reload Apache2 without sudo"
                      echo "TO FIX: Add to /etc/sudoers.d/webserver-reload:"
                      echo "$(whoami) ALL=(ALL) NOPASSWD: /usr/bin/systemctl reload apache2"
                    fi
                  else
                    echo "‚ÑπÔ∏è  No active web server found (nginx/apache2)"
                  fi
                else
                  echo "‚ÑπÔ∏è  systemctl not available"
                fi
                
                if [ "$WEB_SERVER_RESTARTED" = false ]; then
                  echo "‚ö†Ô∏è  Web server not restarted - may need manual restart"
                fi
                echo ""
                
                # Ê∏ÖÁêÜ‰∏¥Êó∂Êñá‰ª∂
                echo "Cleaning up temporary files..."
                rm -f "$ARCHIVE_FILE"
                echo "‚úÖ Temporary files cleaned up"
                echo ""
                
                echo "‚úÖ DEPLOYMENT COMPLETED SUCCESSFULLY"
                echo "Deployment time: $(date)"
                echo "Build ID: $(Build.BuildId)"
          
          # Health check (Êó†sudoÁâàÊú¨)
          - task: SSH@0
            displayName: 'Health Check'
            inputs:
              sshEndpoint: 'VM-SSH-Connection'
              runOptions: 'inline'
              inline: |
                #!/bin/bash
                
                echo "=== HEALTH CHECK STARTED ==="
                echo "Current time: $(date)"
                echo ""
                
                # Á≠âÂæÖÈÉ®ÁΩ≤ÁîüÊïà
                echo "Waiting for deployment to settle..."
                sleep 10
                echo ""
                
                # ÂÆö‰πâÂèòÈáè
                DEPLOY_DIR="/var/www/portfolio"
                BACKUP_BASE_DIR="$HOME/portfolio-backups"
                HEALTH_CHECK_PASSED=false
                
                # Âü∫Êú¨Êñá‰ª∂Ê£ÄÊü•
                echo "Checking deployed files..."
                if [ -d "$DEPLOY_DIR" ] && [ "$(ls -A $DEPLOY_DIR 2>/dev/null)" ]; then
                  echo "‚úÖ Deployment directory contains files"
                  
                  # Ê£ÄÊü•ÂÖ≥ÈîÆÊñá‰ª∂
                  if [ -f "$DEPLOY_DIR/index.html" ]; then
                    echo "‚úÖ index.html found"
                  else
                    echo "‚ö†Ô∏è  index.html not found"
                  fi
                else
                  echo "‚ùå Deployment directory is empty or missing"
                fi
                echo ""
                
                # HTTPÂÅ•Â∫∑Ê£ÄÊü•
                echo "Testing HTTP connectivity..."
                
                # Â∞ùËØïÂ§ö‰∏™URL
                URLS=("http://localhost" "http://127.0.0.1" "http://localhost:80")
                
                for url in "${URLS[@]}"; do
                  echo "Testing: $url"
                  
                  if command -v curl >/dev/null 2>&1; then
                    response=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 --max-time 30 "$url" 2>/dev/null || echo "000")
                    
                    if [ "$response" = "200" ]; then
                      echo "‚úÖ Health check PASSED - HTTP $response from $url"
                      HEALTH_CHECK_PASSED=true
                      
                      # È¢ùÂ§ñÁöÑÂÜÖÂÆπÈ™åËØÅ
                      content=$(curl -s --connect-timeout 5 --max-time 15 "$url" 2>/dev/null || echo "")
                      if echo "$content" | grep -q "<!DOCTYPE html" 2>/dev/null; then
                        echo "‚úÖ HTML content verification passed"
                      elif echo "$content" | grep -q "<html" 2>/dev/null; then
                        echo "‚úÖ HTML content found"
                      else
                        echo "‚ö†Ô∏è  Response received but content verification unclear"
                      fi
                      break
                    else
                      echo "‚ùå Health check failed - HTTP $response from $url"
                    fi
                  else
                    echo "‚ö†Ô∏è  curl not available for testing $url"
                  fi
                done
                echo ""
                
                # Â¶ÇÊûúÂÅ•Â∫∑Ê£ÄÊü•Â§±Ë¥•ÔºåÂ∞ùËØïÂõûÊªö
                if [ "$HEALTH_CHECK_PASSED" = false ]; then
                  echo "‚ùå HEALTH CHECK FAILED"
                  echo ""
                  
                  # Êü•ÊâæÊúÄÊñ∞Â§á‰ªΩ
                  LATEST_BACKUP=$(ls -1t "$BACKUP_BASE_DIR"/backup-* 2>/dev/null | head -n 1)
                  
                  if [ -n "$LATEST_BACKUP" ] && [ -d "$LATEST_BACKUP" ]; then
                    echo "üîÑ INITIATING ROLLBACK..."
                    echo "Using backup: $LATEST_BACKUP"
                    echo ""
                    
                    # Ê∏ÖÈô§ÂΩìÂâçÈÉ®ÁΩ≤
                    echo "Clearing failed deployment..."
                    rm -rf "$DEPLOY_DIR"/*
                    
                    # ÊÅ¢Â§çÂ§á‰ªΩ
                    echo "Restoring from backup..."
                    cp -r "$LATEST_BACKUP"/* "$DEPLOY_DIR"/ 2>/dev/null
                    chmod -R 755 "$DEPLOY_DIR"
                    echo "‚úÖ Backup restored"
                    echo ""
                    
                    # Â∞ùËØïÈáçÂêØWebÊúçÂä°Âô®
                    echo "Attempting to restart web server after rollback..."
                    if command -v systemctl >/dev/null 2>&1; then
                      if systemctl is-active --quiet nginx 2>/dev/null; then
                        if systemctl reload nginx 2>/dev/null; then
                          echo "‚úÖ Nginx reloaded after rollback"
                        else
                          echo "‚ö†Ô∏è  Could not reload Nginx after rollback"
                        fi
                      elif systemctl is-active --quiet apache2 2>/dev/null; then
                        if systemctl reload apache2 2>/dev/null; then
                          echo "‚úÖ Apache2 reloaded after rollback"
                        else
                          echo "‚ö†Ô∏è  Could not reload Apache2 after rollback"
                        fi
                      fi
                    fi
                    
                    echo ""
                    echo "‚úÖ ROLLBACK COMPLETED"
                    echo "Previous version has been restored"
                    
                  else
                    echo "‚ùå NO BACKUP AVAILABLE FOR ROLLBACK"
                    echo "Backup directory: $BACKUP_BASE_DIR"
                    ls -la "$BACKUP_BASE_DIR"/ 2>/dev/null || echo "Backup directory does not exist"
                  fi
                  
                  echo ""
                  echo "‚ùå DEPLOYMENT FAILED - CHECK LOGS AND CONFIGURATION"
                  exit 1
                  
                else
                  echo "‚úÖ HEALTH CHECK PASSED"
                  echo "Site is responding correctly"
                fi
                
                echo ""
                echo "=== HEALTH CHECK COMPLETED ==="
                echo "Status: $([ $HEALTH_CHECK_PASSED = true ] && echo "SUCCESS" || echo "FAILED")"
                echo "Time: $(date)"

- stage: Notification
  displayName: 'Notification Stage'
  dependsOn: 
    - Build
    - Deploy
  condition: always()
  jobs:
  - job: NotifyTeam
    displayName: 'Send Notifications'
    steps:
    - script: |
        echo "=========================================="
        echo "        DEPLOYMENT SUMMARY REPORT        "
        echo "=========================================="
        echo ""
        echo "üìã PROJECT DETAILS:"
        echo "   üì¶ Build ID: $(Build.BuildId)"
        echo "   üåø Branch: $(Build.SourceBranch)"
        echo "   üë§ Triggered by: $(Build.RequestedFor)"
        echo "   ‚è∞ Started: $(System.JobStartTime)"
        echo "   üñ•Ô∏è  Target Server: $(targetServer)"
        echo "   üìÇ Deploy Path: $(deployPath)"
        echo ""
        
        # Ê£ÄÊü•ÊúÄÁªàÁä∂ÊÄÅ
        if [ "$AGENT_JOBSTATUS" = "Succeeded" ]; then
          echo "üéâ DEPLOYMENT SUCCESS!"
          echo ""
          echo "‚úÖ STATUS: COMPLETED SUCCESSFULLY"
          echo "üåê Site URL: http://www.bon.cc"
          echo "üöÄ New version is now LIVE"
          echo "üìä Build artifacts published"
          echo "üîÑ Backup created for rollback safety"
          echo ""
          echo "üìã NEXT STEPS:"
          echo "   ‚Ä¢ Verify site functionality manually"
          echo "   ‚Ä¢ Monitor site performance"
          echo "   ‚Ä¢ Check error logs if needed"
          echo "   ‚Ä¢ Update documentation if required"
          echo ""
          echo "üîó USEFUL LINKS:"
          echo "   ‚Ä¢ Live Site: http://www.bon.cc"
          echo "   ‚Ä¢ Build Logs: Available in Azure DevOps"
          echo "   ‚Ä¢ Backup Location: ~/portfolio-backups/ on server"
          
        else
          echo "‚ùå DEPLOYMENT FAILED!"
          echo ""
          echo "üö® STATUS: FAILED"
          echo "üìù Build ID: $(Build.BuildId)"
          echo "üîç Please check the pipeline logs for detailed error information"
          echo ""
          echo "üõ†Ô∏è  TROUBLESHOOTING CHECKLIST:"
          echo "   ‚Ä¢ Check build logs for compilation errors"
          echo "   ‚Ä¢ Verify SSH connection to $(targetServer)"
          echo "   ‚Ä¢ Ensure server disk space is sufficient"
          echo "   ‚Ä¢ Confirm /var/www/portfolio permissions"
          echo "   ‚Ä¢ Check if web server is running"
          echo "   ‚Ä¢ Verify Node.js compatibility"
          echo ""
          echo "üîÑ RECOVERY OPTIONS:"
          echo "   ‚Ä¢ Re-run the pipeline after fixing issues"
          echo "   ‚Ä¢ Check backup in ~/portfolio-backups/ on server"
          echo "   ‚Ä¢ Manual rollback if needed"
          echo "   ‚Ä¢ Contact system administrator if permissions issues"
          echo ""
          echo "üìß NOTIFICATIONS:"
          echo "   ‚Ä¢ Development team should be notified"
          echo "   ‚Ä¢ Incident response may be required"
        fi
        
        echo ""
        echo "=========================================="
        echo "         END OF DEPLOYMENT REPORT         "
        echo "=========================================="
      displayName: 'Display Deployment Status'